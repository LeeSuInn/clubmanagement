{% if messg %}
<script>
    alert('{{messg}}');
</script>
{% endif %}

{% load static %}
<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
        <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyCKBN_w-mQNi1B0EIvIwOghr7y5afSkIb4",
                authDomain: "club-management-system-bc814.firebaseapp.com",
                projectId: "club-management-system-bc814",
                storageBucket: "club-management-system-bc814.appspot.com",
                messagingSenderId: "99652543260",
                appId: "1:99652543260:web:d17e2bb697763a947950d9",
                measurementId: "G-Z5R49455MZ",    
                databaseURL: "https://club-management-system-bc814-default-rtdb.firebaseio.com/"
            };
          
            firebase.initializeApp(firebaseConfig);
          
            // Firestore 초기화
            const db = firebase.firestore();
        </script>
          
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
        <title>동아리통합시스템</title>
        <style>
            #money-link {
                position: relative;
            }
            
            #money-submenu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                background-color: #fff;
                border: 1px solid #ccc;
                padding: 6px; /* Reduced padding for a more compact look */
                width: 150px; /* Adjusted width for better readability */
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                border-radius: 8px;
            }
            
            #money-submenu li {
                list-style: none;
                margin-bottom: 4px; /* Reduced margin for tighter spacing */
            }
            
            #money-submenu a {
                text-decoration: none;
                color: #333;
                display: block;
                padding: 6px; /* Reduced padding for a more compact look */
                transition: background-color 0.3s ease;
                
                &:hover {
                    background-color: #f2f2f2;
                    border-radius: 4px;
                }
            }
            
            #money-link:hover #money-submenu {
                display: block;
            }
            
            .logo img {
                max-width: 80%;
                height: auto;
            }
            
            #calendar {
                height: 600px;
                width: 900px;
                color: black:
            }

            #calendar a {
                color: black; /* 부모 엘리먼트의 색상 상속 */
            }

            #container{
                display: flex;
                flex-direction: row;
                justify-content: center;
            }
            
            #todo_container{
                border: 1rem solid rgba(0, 0, 0, 0.15);
                margin: 2.3rem auto;
                height: 500px;
                border-radius: 50px; /* 둥글게 만들기 위한 값 */
            }

            #cur_date{
                text-align: center;
                color: black;
                font-size: 30px;
                margin: 0;
                padding: 15px;
            }

            #todoform input{
                text-align: center;
                background-color: hsla(0,0%,84%,.3);
                color: black;
                font-size: 15px;
                width: 400px;
                transition:all, 0.4s;
            }

            #todolist li{
                color: black;
                font-size: 25px;
                width: 350px;
                list-style: none;
                text-align: center;
            }
            #todoform{
                text-align: center;
            }

            .selected-date {
                background-color: #a0d3ff; /* 선택된 날짜의 배경색을 여기에 원하는 색으로 지정 */
            }

        </style>
        
    </head>
    
    <body>
        <header>
            <div class="logo">
                <img src="{% static 'jpeg/logo2.jpeg' %}" alt="로고">
            </div>
            <nav>
                <ul>
                {% if request.session.uid %}
                    <li><a href="/your_view/">동아리통합시스템</a></li>
                {% else %}
                    <li><a href="/index/">동아리통합시스템</a></li>
                {% endif %}
                    <li><a href="/members/">부원관리</a></li>
                    <li id="money-link">
                        <a href="/cash_page/">회비관리</a>
                        <ul class="submenu" id="money-submenu">
                            <li><a href="/cash_page/">회비 내역</a></li>
                            <li><a href="/pay_dues_list/">회비 납부 목록</a></li>
                        </ul>
                    </li>
                    <li><a href="/calendar/">일정관리</a></li>
                {% if request.session.uid %}
                    <li><a href="/logout/">로그아웃</a></li>
                {% else %}
                    <li><a href="/signIn/">로그인</a></li>
                {% endif %}
            </ul>
            </nav>
        </header>
        <div id ="container">
            <div id="calendar"></div>
            <div id="todo_container">
                <p id="cur_date">일정</p>
                <form id="todoform">
                    <input required type="text" placeholder="일정을 작성해주세요"/>
                </form>
                <ul id="todolist">
                </ul>
            </div>
        </div>
            
        <script>
            var calendar;
            var selectedDate;

            document.addEventListener('DOMContentLoaded', function() {
                var calendarEl = document.getElementById('calendar');
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    selectable: true,
                    events:[],
  
                    dateClick: function(info) {
                        console.log("Clicked event occurs: data = " + info.dateStr);

                        // 현재 클릭된 날짜와 선택된 날짜가 다르면 스타일 초기화
                        if (selectedDate !== info.dateStr) {
                            resetSelectedDateStyle();
                        }

                        selectedDate = info.dateStr;

                        // 선택된 날짜에 스타일 적용
                        info.dayEl.classList.add('selected-date');

                        // 선택된 날짜의 Todo 리스트를 불러옴
                        loadTodoListFromFirestore(selectedDate);  // 페이지 로드 시 Firestore 데이터를 가져와서 표시
                    }
                });
                loadAllTodoListsFromFirestore()
                calendar.render()
            });
            
            //to do 리스트 만들기
            const todoform = document.querySelector("#todoform")
            const todoInput = document.querySelector("#todoform input")
            const todoList_ul = document.querySelector("#todolist")

            // 각 날짜별 Todo 리스트를 관리하는 객체
            const todoLists = {};

            function handleFormSubmit(event) {
                event.preventDefault();
            
                const curTodo = todoInput.value;
                console.log("todoinput value: " + curTodo);
            
                todoInput.value = "";
            
                const todo_cur_li = document.createElement("li");
                const todo_cur_span = document.createElement("span");
            
                todo_cur_span.innerText = curTodo;
            
                todo_cur_li.appendChild(todo_cur_span);
                todoList_ul.appendChild(todo_cur_li);
            
                // 캘린더에도 일정 추가
                if (selectedDate && curTodo) {
                    if (!todoLists[selectedDate]) {
                        todoLists[selectedDate] = [];
                    }
            
                    todoLists[selectedDate].push(curTodo);
            
                    // FullCalendar에 일정 추가
                    const newEvent = {
                        title: curTodo,
                        start: selectedDate,
                        id: selectedDate,
                    };
            
                    calendar.addEvent(newEvent)
            
                    // 일정 추가 후에 선택된 날짜의 스타일을 초기화
                    resetSelectedDateStyle();
                }
            
                // Update Firestore
                saveTodoListToFirestore();
            }
            
            // Add a single event listener for the form submission
            todoform.addEventListener("submit", handleFormSubmit);
            
            // 선택된 날짜의 스타일을 초기화하는 함수
            function resetSelectedDateStyle() {
                const selectedDateElement = document.querySelector('.selected-date');
                if (selectedDateElement) {
                    selectedDateElement.classList.remove('selected-date');
                }
            }

            // Firestore에 Todo 리스트 저장
            function saveTodoListToFirestore() {
                if (selectedDate && todoLists[selectedDate]) {
                    db.collection('{{uid}}').doc('동아리').collection('일정').doc(selectedDate).set({
                    todos: todoLists[selectedDate]
                });
                }
            }
            
            // Firestore에서 Todo 리스트 불러오기
            function loadTodoListFromFirestore(date) {
                if (selectedDate) {
                    const docRef = db.collection('{{uid}}').doc('동아리').collection('일정').doc(date)

                    // Firestore의 데이터가 변경될 때 감지하는 이벤트
                    docRef.get().then((doc) => {
                        if (doc.exists) {
                            // Firestore에서 Todo 리스트를 불러오고 화면에 표시
                            const todosData = doc.data();
                            todoList_ul.innerHTML = "";
                            todosData.todos.forEach(todo => {
                                const todo_cur_li = document.createElement("li");
                                const todo_cur_span = document.createElement("span");
                                todo_cur_span.innerText = todo;
                                todo_cur_li.appendChild(todo_cur_span);
                                todoList_ul.appendChild(todo_cur_li);
                            });

                            // FullCalendar의 이벤트를 업데이트
                            updateFullCalendarEvents(selectedDate, todosData.todos);
                            todoLists[selectedDate] = todosData.todos;
                            saveTodoListToFirestore()
                            loadAllTodoListsFromFirestore()
                        } 
                        else{
                            todoList_ul.innerHTML = "";
                        }
                    });
                }
            }

            // Firestore에서 모든 Todo 리스트 불러오기
            function loadAllTodoListsFromFirestore() {
                // '동아리/일정' 컬렉션에서 모든 문서 가져오기
                db.collection('{{uid}}').doc('동아리').collection('일정').get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        // 각 문서의 데이터를 가져와서 달력에 표시
                        const date = doc.id;
                        const todosData = doc.data();
                        const todos = todosData.todos;

                        // 선택된 날짜가 있을 때와 없을 때를 구분하여 처리
                        if (selectedDate) {
                            // 선택된 날짜가 있는 경우
                            if (date !== selectedDate) {
                                // 선택된 날짜와 동일한 경우에만 FullCalendar에 이벤트 추가
                                todos.forEach((todo) => {
                                    const newEvent = {
                                        title: todo,
                                        start: date,
                                        id: date + '_' + todo  // 각 이벤트에 고유한 ID를 부여
                                    };
                                    calendar.addEvent(newEvent)
                                });
                            }
                        } else {
                            // 선택된 날짜가 없는 경우 모든 날짜의 이벤트를 추가
                            todos.forEach((todo) => {
                                const newEvent = {
                                    title: todo,
                                    start: date,
                                    id: date + '_' + todo  // 각 이벤트에 고유한 ID를 부여
                                };
                                calendar.addEvent(newEvent)
                            });
                        }
                    // todoLists 객체 업데이트
                    todoLists[date] = todos;
                    });
                }).catch((error) => {
                    console.error("Error getting documents: ", error);
                });
            }
            
            // FullCalendar의 이벤트를 업데이트하는 함수
            function updateFullCalendarEvents(date, todos) {
                // 현재 선택된 날짜의 모든 이벤트를 제거
                calendar.getEvents().forEach((existingEvent) => {
                    existingEvent.remove();
                });

                // 새로운 이벤트를 추가
                todos.forEach((todo) => {
                    const newEvent = {
                        title: todo,
                        start: date,
                        id: date + '_' + todo  // 각 이벤트에 고유한 ID를 부여
                    };
                    calendar.addEvent(newEvent);
                });
            }
        </script>
    </body>
</html>
