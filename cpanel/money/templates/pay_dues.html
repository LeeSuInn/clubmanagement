{% load static %}
<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

        <style>
            table {
                border-collapse: collapse;
                width: 100%;
            }
    
            th, td {
                border: 1px solid #dddddd;
                text-align: left;
                padding: 8px;
            }
    
            th {
                background-color: #f2f2f2;
            }

            #money-link {
                position: relative;
            }

            #money-submenu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                background-color: #fff;
                border: 1px solid #ccc;
                padding: 8px;
                width: 115px; /* 너비 축소 */
            }
                
            #money-submenu li {
                list-style: none; 
                margin-bottom: 5px; /* 각 메뉴 간격 조정 */
            }
        
            #money-submenu a {
                text-decoration: none;
                color: #333;
                display: block;
                padding: 3px; /* 내부 여백 축소 */
                white-space: nowrap; /* 텍스트 줄바꿈 방지 */
            }
        
            #money-link:hover #money-submenu {
                display: block;
            }

            #editButton {
                float: right;
                margin-top: -50px;
                margin-right: 20px; 
                cursor: pointer;
            }
    
            .edit-mode {
                background-color: #e6f7ff; /* 편집 모드 배경색 */
            }
        
            .saveButton {
                float: right;
                margin-top: -50px;
                margin-right: 20px; 
                cursor: pointer;
                display: none;
                cursor: pointer;
            }
            </style>

        <title>동아리통합시스템</title>
    </head>
    <body>
        <header>
            <div class="logo">로고</div>
            <nav>
                <ul>
                {% if request.session.uid %}
                    <li><a href="/your_view/">동아리통합시스템</a></li>
                {% else %}
                    <li><a href="/index/">동아리통합시스템</a></li>
                {% endif %}
                    <li><a href="/members/">부원관리</a></li>
                    <li id="money-link">
                        <a href="/money/">회비관리</a>
                        <ul class="submenu" id="money-submenu">
                            <li><a href="/money/">회비 목록</a></li>
                            <li><a href="/pay_dues_list/">회비 납부 내역</a></li>
                        </ul>
                    </li>
                    <li><a href="/calendar/">일정관리</a></li>
                {% if request.session.uid %}
                    <li><a href="/logout/">로그아웃</a></li>
                {% else %}
                    <li><a href="/signIn/">로그인</a></li>
                {% endif %}
                </ul>
            </nav>
        </header>

        <h2>회비 납부 내역</h2>

        <button id="editButton" onclick="editButtonClick()">수정하기</button>
        <button class="saveButton" style="display: none;" id="saveButton" onclick="saveButtonClick()">수정 완료</button>
    
        <table id="payment_management_Table">
            <thead>
                <tr>
                    <th>학번</th>
                    <th>이름</th>
                    <th>
                        1학기
                        <button class="sortButton" data-column="2" data-type="string">정렬</button>
                    </th>
                    <th>
                        2학기
                        <button class="sortButton" data-column="3" data-type="string">정렬</button>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for payment in payments %}
                <tr>
                    <td>{{ payment.학번 }}</td>
                    <td>{{ payment.이름 }}</td>
                    <td class="editable">
                        <span class="semester" id="semester-1-{{ forloop.counter }}">{{ payment.1학기|yesno:"O,X" }}</span>
                        <select class="editable-options" id="semester-1-edit-{{ forloop.counter }}" data-counter="{{ forloop.counter }}" style="display: none;">
                            <option value="true" {% if payment.1학기 %}selected{% endif %}>O</option>
                            <option value="false" {% if not payment.1학기 %}selected{% endif %}>X</option>
                        </select>
                    </td>
                    <td class="editable">
                        <span class="semester" id="semester-2-{{ forloop.counter }}">{{ payment.2학기|yesno:"O,X" }}</span>
                        <select class="editable-options" id="semester-2-edit-{{ forloop.counter }}" data-counter="{{ forloop.counter }}" style="display: none;">
                            <option value="true" {% if payment.2학기 %}selected{% endif %}>O</option>
                            <option value="false" {% if not payment.2학기 %}selected{% endif %}>X</option>
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>


        <script>
                //1, 2학기 납부내역 수정하기
                function editButtonClick() {
                    // 각 행의 셀을 수정 가능한 Select Box로 변경
                    var rows = document.querySelectorAll('#payment_management_Table tbody tr');
                    rows.forEach(function (row) {
                        var cell3 = row.querySelector('td:nth-child(3)');
                        var cell4 = row.querySelector('td:nth-child(4)');
                        var value1 = cell3.textContent.trim() === 'O';
                        var value2 = cell4.textContent.trim() === 'O';
                        var select1 = '<select class="semester-select1"><option value="true" ' + (value1 ? 'selected' : '') + '>O</option><option value="false" ' + (!value1 ? 'selected' : '') + '>X</option></select>';
                        var select2 = '<select class="semester-select2"><option value="true" ' + (value2 ? 'selected' : '') + '>O</option><option value="false" ' + (!value2 ? 'selected' : '') + '>X</option></select>';
                        cell3.innerHTML = select1;
                        cell4.innerHTML = select2;
                    });
        
                    // 수정 버튼 숨기고 저장 버튼 표시
                    document.getElementById('editButton').style.display = 'none';
                    document.getElementById('saveButton').style.display = 'block';
                }
        
                function saveButtonClick() {
                    // 수정된 데이터 저장
                    var updatedData = [];
                    var rows = document.querySelectorAll('#payment_management_Table tbody tr');
                    rows.forEach(function (row) {
                        var studentNumber = row.querySelector('td:nth-child(1)').textContent;
                        var select1 = row.querySelector('.semester-select1:nth-child(1)');
                        var select2 = row.querySelector('.semester-select2:nth-child(1)'); //NULL
                        
                        var value1 = select1 ? select1.value === 'true' : false;
                        var value2 = select2 ? select2.value === 'true' : false;

                        updatedData.push({
                            '학번': studentNumber,
                            '1학기': value1,
                            '2학기': value2
                        });
                        console.log(updatedData)
                    });
                
                    fetch('/pay_dues_edit/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'  // Django에서 CSRF 보호를 위한 토큰
                        },
                        body: JSON.stringify({ 'updated_data': updatedData })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('서버 응답:', data);
                        // 서버에서의 응답에 따른 추가 로직 수행 가능
                    })
                    .catch(error => {
                        console.error('에러 발생:', error);
                    });
        
                    // 원래 상태로 복구
                    rows.forEach(function (row) {
                        var cell3 = row.querySelector('td:nth-child(3)');
                        var cell4 = row.querySelector('td:nth-child(4)');
                        var value1 = cell3.querySelector('.semester-select1').value === 'true';
                        var value2 = cell4.querySelector('.semester-select2').value === 'true';
                        cell3.innerHTML = value1 ? 'O' : 'X';
                        cell4.innerHTML = value2 ? 'O' : 'X';
                    });

                    // 수정 버튼 표시하고 저장 버튼 숨기기
                    document.getElementById('editButton').style.display = 'block';
                    document.getElementById('saveButton').style.display = 'none';
                    }
        </script>
    </body>
</html>
